{% extends "base.html" %}

{% block title %}
Barcode æƒæçµæœ
{% endblock %}

{% block head %}
<style>

    body {
        background-color: #CCE8CC;
        color: #3A3A3A;
    }

    .container {
        margin-top: 50px; /* è®“å…§å®¹å¾€ä¸‹ç§»ï¼Œé¿å…è¢«ç‹€æ…‹æ¢æ“‹ä½ */
    }
</style>
{% endblock %}

{% block body %}
<div id="statusBar" class="fixed-top text-white text-center py-2 bg-secondary">
    ğŸ”„ æª¢æŸ¥é€£ç·šä¸­...
</div>
<div class="container">

    <div class="row">
        <div class="col-6">
            <div class="card">
                <div class="card-header">
                    Scan Result
                </div>
                <div class="card-body">
                    <ul id="scanResult"></ul>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card">
                <div class="card-header">
                    Connected Device
                </div>
                <div class="card-body">
                    <ul id="connectedDevices"></ul>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
    let ws;

    function setStatus(isConnected, remainingTime = 0) {
            const statusBar = document.getElementById('statusBar');
            if (isConnected) {
                statusBar.textContent = 'âœ… WebSocket å·²é€£ç·š';
                statusBar.className = 'fixed-top text-white text-center py-2 bg-success';
            } else {
                if (remainingTime > 0) {
                    statusBar.textContent = `âŒ WebSocket æ–·ç·šï¼Œå°‡æ–¼ ${remainingTime} ç§’å¾Œé‡è©¦...`;
                } else {
                    statusBar.textContent = 'âŒ WebSocket æ–·ç·šï¼Œå˜—è©¦é‡æ–°é€£ç·š...';
                }
                statusBar.className = 'fixed-top text-white text-center py-2 bg-danger';
            }
        }

    const cleanConnectedDevice = () => {
        let connectedDevices = document.getElementById('connectedDevices');
        let children = [...connectedDevices.children];

        for (let i = 0; i < children.length; i++) {
            if (children[i].nodeType !== Node.TEXT_NODE) {
                connectedDevices.removeChild(children[i]);
            }
        }
    }


    const Li = (context) => {
        let li = document.createElement('li')
        let this_context = document.createTextNode(context)
        li.appendChild(this_context)
        return li
    }
    const protocol = {
        "http:": "ws",
        "https:": "wss"
    }
    let retryInterval = 5000;  // åˆå§‹é‡è©¦é–“éš”ï¼š5ç§’
    const maxRetryInterval = 30000; // æœ€å¤§é‡è©¦é–“éš”ï¼š30ç§’
    let retryTimer;
    let countdownTimer;


    function connectWebSocket() {
        if (ws) {
            ws.close(); // é—œé–‰èˆŠçš„é€£ç·š
        }
        const wsUrl = `${protocol[document.location.protocol]}://${document.location.host}/ws/result`;
        ws = new WebSocket(wsUrl);
        ws.onmessage = function (event) {
            let runtimeData;
            try {
                runtimeData = JSON.parse(JSON.parse(event.data));
            } catch (error) {
                console.error("JSON è§£æéŒ¯èª¤:", error);
                return;  // å¦‚æœè§£æå¤±æ•—å°±ç›´æ¥è¿”å›
            }
            if ('devices' in runtimeData) {
                cleanConnectedDevice()
                let connectedDevices = document.getElementById('connectedDevices')
                let devices = runtimeData['devices']
                devices.forEach(device => {
                    connectedDevices.appendChild(Li(`${device["connect_id"]} - \n${device["name"]}`));
                });
            } else if ('barcode' in runtimeData) {
                let scanResult = document.getElementById('scanResult')
                let barcode = runtimeData['barcode']
                scanResult.appendChild(Li(`${barcode["code"]}`));
            }
        };

        ws.onopen = function () {
            console.log("âœ… WebSocket é€£ç·šæˆåŠŸ");
            setStatus(true);
            retryInterval = 5000; // é€£ç·šæˆåŠŸå¾Œé‡ç½®é–“éš”ç‚º5ç§’
            clearTimeout(retryTimer); // æ¸…é™¤å€’æ•¸è¨ˆæ™‚
            clearInterval(countdownTimer);
        };

        ws.onclose = function () {
            console.log("âŒ WebSocket æ–·ç·šï¼Œå˜—è©¦é‡æ–°é€£ç·š...");
            let remainingTime = retryInterval / 1000;
            setStatus(false, retryInterval / 1000);
            // é–‹å§‹å€’æ•¸
                countdownTimer = setInterval(function() {
                    remainingTime--;
                    setStatus(false, remainingTime);

                    if (remainingTime <= 0) {
                        clearInterval(countdownTimer);  // åœæ­¢å€’æ•¸
                        retryTimer = setTimeout(connectWebSocket, retryInterval); // å»¶é²é€£ç·š
                        // æ¯æ¬¡é‡è©¦æ™‚ï¼Œå°‡é‡è©¦é–“éš”å¢é•· 5 ç§’ï¼Œç›´åˆ°æœ€å¤§ç‚º 30 ç§’
                        retryInterval = Math.min(retryInterval + 5000, maxRetryInterval);
                    }
                }, 1000); // æ¯ç§’æ›´æ–°ä¸€æ¬¡
        };

        ws.onerror = function (error) {
            console.error("WebSocket ç™¼ç”ŸéŒ¯èª¤", error);
            ws.close(); // å‡ºéŒ¯æ™‚é—œé–‰é€£ç·šï¼Œè§¸ç™¼ `onclose`
        };

    }

    // ğŸš€ é é¢è¼‰å…¥æ™‚è‡ªå‹•é€£ç·š
    connectWebSocket();
</script>
{% endblock %}
